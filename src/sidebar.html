<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body { padding: 10px; font-size: 13px; background-color: #f8f9fa; }
    /* ã‚¿ãƒ–å‘¨ã‚Š */
    .nav-tabs .nav-link { color: #495057; font-size: 12px; padding: 8px 10px; }
    .nav-tabs .nav-link.active { font-weight: bold; color: #0d6efd; }
    
    /* ã‚«ãƒ³ãƒšã‚¨ãƒªã‚¢ */
    .timer-badge { background: #e9ecef; color: #495057; padding: 2px 6px; border-radius: 4px; font-size: 11px; float: right; }
    .company-info-box { background: #e7f1ff; border-left: 3px solid #0d6efd; padding: 8px; font-size: 12px; margin-bottom: 10px; }
    
    /* è­°äº‹éŒ²ï¼ˆãƒãƒ£ãƒƒãƒˆé¢¨ï¼‰ã‚¨ãƒªã‚¢ */
    #qa-container { height: 300px; overflow-y: auto; background: white; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px; margin-bottom: 10px; }
    .qa-item { margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px dashed #eee; }
    .qa-q { color: #d63384; font-weight: bold; margin-bottom: 2px; } /* è³ªå•ã¯ãƒ”ãƒ³ã‚¯ */
    .qa-a { color: #0f5132; margin-left: 10px; } /* å›ç­”ã¯ç·‘ */
    
    /* ã‚¹ãƒ­ãƒƒãƒˆã‚¢ã‚¤ãƒ†ãƒ ï¼ˆæ—¥ç¨‹èª¿æ•´ï¼‰ */
    .slot-item { cursor: pointer; transition: all 0.2s; }
    .slot-item:hover { background-color: #e9ecef; }
    
    /* å…±é€š */
    textarea { resize: vertical; min-height: 80px; font-size: 12px; }
    .btn-xs { padding: 2px 5px; font-size: 11px; }
  </style>
</head>
<body>

  <div class="mb-3">
    <select id="company-select" class="form-select form-select-sm" onchange="loadCompanyData()">
      <option value="" selected>ä¼æ¥­ã‚’é¸æŠã—ã¦ãã ã•ã„...</option>
      </select>
  </div>

  <ul class="nav nav-tabs mb-3" id="mainTab" role="tablist">
    <li class="nav-item"><button class="nav-link active" data-bs-target="#prep" data-bs-toggle="tab">ğŸ“ æº–å‚™</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-target="#live" data-bs-toggle="tab">ğŸ™ æœ¬ç•ª</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-target="#schedule" data-bs-toggle="tab">ğŸ—“ æ—¥ç¨‹</button></li>
    <li class="nav-item"><button class="nav-link text-warning fw-bold" data-bs-target="#offer" data-bs-toggle="tab">âš–ï¸ ã‚ªãƒ•ã‚¡ãƒ¼</button></li>
    <li class="nav-item"><button class="nav-link text-success fw-bold" data-bs-target="#register" data-bs-toggle="tab">ğŸ“¥ ç™»éŒ²</button></li>
  </ul>

  <div class="tab-content">

    <div class="tab-pane fade show active" id="prep">
      <div class="mb-2">
        <label class="form-label fw-bold small">æ±‚äººæƒ…å ±ãƒ»ç‰¹å¾´ãƒ¡ãƒ¢</label>
        <textarea id="prep-business" class="form-control form-control-sm" style="min-height: 120px;" placeholder="ç™»éŒ²ã‚¿ãƒ–ã‹ã‚‰ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã¨ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™"></textarea>
      </div>

      <div class="mb-2">
        <label class="form-label fw-bold small">
          å¿—æœ›å‹•æ©Ÿ (å€‹åˆ¥)
          <span id="motivation-timer" class="timer-badge">0æ–‡å­— / 0.0åˆ†</span>
        </label>
        <textarea id="prep-motivation" class="form-control" rows="6" 
          placeholder="ãªãœã“ã®ä¼šç¤¾ãªã®ã‹ï¼Ÿ" oninput="calcTime(this)"></textarea>
      </div>

      <div class="mb-3">
        <label class="form-label fw-bold small">é€†è³ªå•ãƒªã‚¹ãƒˆ</label>
        <textarea id="prep-questions" class="form-control" rows="4" placeholder="ãƒ»1æ—¥ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ï¼Ÿ&#13;&#10;ãƒ»è©•ä¾¡åˆ¶åº¦ã«ã¤ã„ã¦..."></textarea>
      </div>

      <div class="company-info-box">
        <strong>ğŸ’¡ å…±é€šã®è»¢è·è»¸:</strong><br>
        <span id="common-reason">Loading...</span>
      </div>

      <button class="btn btn-primary btn-sm w-100" onclick="savePrep()">ğŸ’¾ æº–å‚™ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜</button>
    </div>

    <div class="tab-pane fade" id="live">
      <div class="d-flex justify-content-between mb-2">
        <input type="text" id="live-interviewer" class="form-control form-control-sm me-2" placeholder="é¢æ¥å®˜å">
        <button class="btn btn-outline-danger btn-sm" onclick="clearLog()">Clear</button>
      </div>

      <div id="qa-container">
        <div class="text-muted text-center small mt-5">ã“ã“ã«QAãƒ­ã‚°ãŒè¿½åŠ ã•ã‚Œã¾ã™</div>
      </div>

      <div class="mb-2">
        <div class="input-group mb-1">
          <span class="input-group-text bg-light text-danger small">Q</span>
          <input type="text" id="input-q" class="form-control form-control-sm" placeholder="èã‹ã‚ŒãŸã“ã¨">
        </div>
        <div class="input-group">
          <span class="input-group-text bg-light text-success small">A</span>
          <textarea id="input-a" class="form-control form-control-sm" placeholder="ç­”ãˆãŸã“ã¨ï¼ˆãƒ¡ãƒ¢ï¼‰" rows="2"></textarea>
        </div>
      </div>
      <button class="btn btn-secondary btn-sm w-100 mb-3" onclick="addQA()">â• ãƒ­ã‚°ã«è¿½åŠ  (Enter)</button>

      <div class="border-top pt-2">
        <label class="form-label fw-bold small">æ‰€æ„Ÿãƒ»ãƒã‚¯ã‚¹ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³</label>
        <textarea id="live-impression" class="form-control form-control-sm mb-2" rows="2"></textarea>
        <button class="btn btn-danger btn-sm w-100" onclick="saveMinutes()">ğŸ é¢æ¥çµ‚äº†ï¼†è­°äº‹éŒ²ä¿å­˜</button>
      </div>
    </div>

    <div class="tab-pane fade" id="schedule">
      <div class="mb-2 border-bottom pb-2">
         <label class="form-label fw-bold small text-primary">æ¤œç´¢ç¯„å›²</label>
         <div class="input-group input-group-sm mb-1">
           <span class="input-group-text">From</span>
           <input type="date" id="sched-start" class="form-control">
         </div>
         <div class="input-group input-group-sm mb-2">
           <span class="input-group-text">To&nbsp;&nbsp;&nbsp;&nbsp;</span>
           <input type="date" id="sched-end" class="form-control">
         </div>
         
         <label class="form-label fw-bold small text-primary">æ‰€è¦æ™‚é–“ (åˆ†)</label>
         <div class="input-group input-group-sm mb-2">
           <input type="number" id="sched-duration" class="form-control" value="60" step="15">
           <span class="input-group-text">åˆ†</span>
           <button class="btn btn-primary" onclick="searchSlots()">ğŸ” æ¤œç´¢</button>
         </div>
      </div>

      <div id="slots-container" class="mb-2 border rounded p-2 bg-white" style="height: 150px; overflow-y: auto;">
        <div class="text-center text-muted small mt-4">æ¡ä»¶ã‚’æŒ‡å®šã—ã¦æ¤œç´¢ã—ã¦ãã ã•ã„</div>
      </div>
      
      <label class="form-label fw-bold small">å‡ºåŠ›çµæœ (é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼)</label>
      <textarea id="result-area" class="form-control mb-2" rows="4"></textarea>
      <button class="btn btn-success btn-sm w-100" onclick="copyToClip()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
    </div>

    <div class="tab-pane fade" id="offer">
      <div class="alert alert-warning p-2 small mb-2">
        <i class="fas fa-balance-scale"></i> å†…å®šãŒå‡ºãŸã‚‰æ¡ä»¶ã‚’å…¥åŠ›ã€‚<br>
        é‡ã¿ä»˜ã‘ã‚¹ã‚³ã‚¢ã§å®¢è¦³çš„ã«æ¯”è¼ƒã—ã¾ã™ã€‚
      </div>

      <div class="mb-2 border-bottom pb-2">
        <label class="form-label fw-bold small text-primary">ğŸ’° æç¤ºå¹´å (Q.çµ¦ä¸ã¯?)</label>
        <div class="input-group input-group-sm">
          <input type="number" id="offer-salary" class="form-control" placeholder="ä¾‹: 6500000">
          <span class="input-group-text">å††</span>
        </div>
      </div>

      <div class="mb-2 border-bottom pb-2">
        <label class="form-label fw-bold small text-primary">ğŸ¢ åƒãæ–¹ãƒ»ç¦åˆ©åšç”Ÿ (Q.ãƒªãƒ¢ãƒ¼ãƒˆã¯?)</label>
        <textarea id="offer-workstyle" class="form-control form-control-sm" rows="2" placeholder="ãƒ•ãƒ«ãƒªãƒ¢ãƒ¼ãƒˆå¯ã€ã‚³ã‚¢ã‚¿ã‚¤ãƒ ãªã—ã€æ›¸ç±è³¼å…¥è£œåŠ©ã‚ã‚Š..."></textarea>
        
        <div class="mt-1 d-flex align-items-center justify-content-between">
           <span class="small">åƒãæ–¹æº€è¶³åº¦:</span>
           <select id="offer-work-score" class="form-select form-select-sm w-50">
             <option value="3">3 (æ™®é€š)</option>
             <option value="5">5 (æœ€é«˜)</option>
             <option value="1">1 (ä¸æº€)</option>
           </select>
        </div>
      </div>

      <div class="mb-2 border-bottom pb-2">
        <label class="form-label fw-bold small text-primary">ğŸ’» æŠ€è¡“ãƒ»ã‚«ãƒ«ãƒãƒ£ãƒ¼ (Q.ç’°å¢ƒã¯?)</label>
        <div class="row g-2">
          <div class="col-6">
            <span class="small d-block">æŠ€è¡“ç’°å¢ƒ</span>
            <select id="offer-tech-score" class="form-select form-select-sm">
              <option value="3">3 (æ™®é€š)</option>
              <option value="5">5 (æœ€é«˜)</option>
              <option value="1">1 (ãƒ¬ã‚¬ã‚·ãƒ¼)</option>
            </select>
          </div>
          <div class="col-6">
            <span class="small d-block">ã‚«ãƒ«ãƒãƒ£ãƒ¼</span>
            <select id="offer-culture-score" class="form-select form-select-sm">
              <option value="3">3 (æ™®é€š)</option>
              <option value="5">5 (ãƒãƒƒãƒ)</option>
              <option value="1">1 (åˆã‚ãªã„)</option>
            </select>
          </div>
        </div>
      </div>

      <div class="mb-2">
        <label class="form-label fw-bold small text-success">ğŸ’– é­…åŠ›ãƒã‚¤ãƒ³ãƒˆ (Q.ãªãœã“ã“?)</label>
        <textarea id="offer-pros" class="form-control form-control-sm" rows="2" placeholder="CTOãŒå„ªç§€ã€ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆã®ç¤¾ä¼šçš„æ„ç¾©..."></textarea>
      </div>
      
      <div class="mb-3">
        <label class="form-label fw-bold small text-danger">ğŸ¤” æ‡¸å¿µãƒã‚¤ãƒ³ãƒˆ (Q.è¿·ã„ã¯?)</label>
        <textarea id="offer-cons" class="form-control form-control-sm" rows="2" placeholder="ã‚ªãƒ³ãƒœãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä½“åˆ¶ãŒæœªæ•´å‚™..."></textarea>
      </div>

      <button class="btn btn-warning btn-sm w-100 fw-bold mb-3" onclick="saveOffer()">ğŸ“Š ã‚¹ã‚³ã‚¢è¨ˆç®— & ä¿å­˜</button>

      <div id="offer-ranking" class="bg-white border rounded p-2 small">
        <div class="text-center text-muted">ãƒ‡ãƒ¼ã‚¿ãªã—</div>
      </div>
    </div>

    <div class="tab-pane fade" id="register">
      <div class="alert alert-success p-2 small mb-2">
        <i class="fas fa-file-import"></i> æ±‚äººç¥¨ã®å†…å®¹ã‚’å…¥åŠ›ã—ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆã€‚<br>
        é¢æ¥æº–å‚™ã‚·ãƒ¼ãƒˆã«è‡ªå‹•åæ˜ ã•ã‚Œã¾ã™ã€‚
      </div>

      <form id="reg-form" onsubmit="handleRegister(event)">
        <div class="mb-2">
          <label class="form-label fw-bold small">ä¼šç¤¾URL</label>
          <div class="input-group input-group-sm">
             <input type="url" name="url" class="form-control" id="reg-url" placeholder="https://..." onchange="tryFetchTitle()">
          </div>
          <div class="form-text" style="font-size:10px">URLã‚’å…¥åŠ›ã™ã‚‹ã¨ä¼æ¥­åã‚’è‡ªå‹•å–å¾—ã—ã¾ã™</div>
        </div>

        <div class="mb-2">
          <label class="form-label fw-bold small">ä¼æ¥­å <span class="text-danger">*</span></label>
          <input type="text" name="name" class="form-control form-control-sm" id="reg-name" required>
        </div>

        <div class="mb-2">
          <label class="form-label fw-bold small">æ±‚äººã‚¿ã‚¤ãƒˆãƒ«</label>
          <input type="text" name="jobTitle" class="form-control form-control-sm" placeholder="ä¾‹: ã‚·ãƒ‹ã‚¢ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢">
        </div>

        <div class="mb-2">
          <label class="form-label fw-bold small">æƒ³å®šçµ¦ä¸</label>
          <input type="text" name="salary" class="form-control form-control-sm" placeholder="ä¾‹: 600-900ä¸‡å††">
        </div>

        <div class="mb-2">
          <label class="form-label fw-bold small">ä»•äº‹å†…å®¹</label>
          <textarea name="jobDescription" class="form-control form-control-sm" rows="4" placeholder="ãƒ»Goã‚’ç”¨ã„ãŸAPIé–‹ç™º..."></textarea>
        </div>

        <div class="mb-3">
          <label class="form-label fw-bold small">æ±‚ã‚ã‚‹äººç‰©åƒãƒ»ã‚¹ã‚­ãƒ«</label>
          <textarea name="persona" class="form-control form-control-sm" rows="3" placeholder="ãƒ»ãƒãƒ¼ãƒ é–‹ç™ºçµŒé¨“3å¹´ä»¥ä¸Š..."></textarea>
        </div>

        <button type="submit" class="btn btn-success w-100 fw-bold">ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ</button>
      </form>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let qaLogData = []; 

    // --- åˆæœŸåŒ– ---
    window.onload = function() {
      google.script.run.withSuccessHandler(initSidebar).apiGetInitData();
      updateOfferRanking();
      
      // æ—¥ä»˜åˆæœŸå€¤
      const today = new Date();
      const nextWeek = new Date();
      nextWeek.setDate(today.getDate() + 7);
      
      document.getElementById('sched-start').value = formatDateForInput(today);
      document.getElementById('sched-end').value = formatDateForInput(nextWeek);
    };

    function formatDateForInput(date) {
      const y = date.getFullYear();
      const m = ('0' + (date.getMonth() + 1)).slice(-2);
      const d = ('0' + date.getDate()).slice(-2);
      return `${y}-${m}-${d}`;
    }

    function initSidebar(data) {
      const select = document.getElementById('company-select');
      // ç¾åœ¨ã®é¸æŠå€¤ã‚’ä¿æŒ
      const currentVal = select.value;
      
      select.innerHTML = '<option value="" selected>ä¼æ¥­ã‚’é¸æŠã—ã¦ãã ã•ã„...</option>';
      data.companies.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.text = c.name;
        select.appendChild(opt);
      });
      
      if(currentVal) select.value = currentVal;
      
      document.getElementById('common-reason').textContent = data.commonReason;
    }

    function loadCompanyData() {
      const companyId = document.getElementById('company-select').value;
      if(!companyId) return;

      google.script.run.withSuccessHandler(fillPrepData).apiGetPrepData(companyId);
      google.script.run.withSuccessHandler(fillOfferData).apiGetOfferDetail(companyId);
    }

    // --- Tab 1 (Prep) ---
    function fillPrepData(data) {
      document.getElementById('prep-business').value = data.businessContent;
      document.getElementById('prep-motivation').value = data.motivation;
      document.getElementById('prep-questions').value = data.questions;
      calcTime(document.getElementById('prep-motivation')); 
    }

    function calcTime(el) {
      const len = el.value.length;
      const min = (len / 300).toFixed(1);
      document.getElementById('motivation-timer').textContent = `${len}æ–‡å­— / ç´„${min}åˆ†`;
    }

    function savePrep() {
      const select = document.getElementById('company-select');
      if(!select.value) { alert("ä¼æ¥­ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

      const form = {
        companyId: select.value,
        companyName: select.options[select.selectedIndex].text,
        businessContent: document.getElementById('prep-business').value,
        motivation: document.getElementById('prep-motivation').value,
        questions: document.getElementById('prep-questions').value
      };

      const btn = event.target;
      const originalText = btn.textContent;
      btn.textContent = "ä¿å­˜ä¸­...";
      
      google.script.run.withSuccessHandler(() => {
        btn.textContent = originalText;
        alert("æº–å‚™ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ");
      }).apiSavePrepData(form);
    }

    // --- Tab 2 (Live) ---
    function addQA() {
      const q = document.getElementById('input-q').value;
      const a = document.getElementById('input-a').value;
      if(!q && !a) return;

      qaLogData.push({ q: q, a: a });
      
      const container = document.getElementById('qa-container');
      if(qaLogData.length === 1) container.innerHTML = ''; 

      const div = document.createElement('div');
      div.className = 'qa-item';
      div.innerHTML = `<div class="qa-q">Q. ${q}</div><div class="qa-a">A. ${a}</div>`;
      container.appendChild(div);
      container.scrollTop = container.scrollHeight;

      document.getElementById('input-q').value = '';
      document.getElementById('input-a').value = '';
      document.getElementById('input-q').focus();
    }

    function saveMinutes() {
      const select = document.getElementById('company-select');
      if(!select.value) { alert("ä¼æ¥­ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
      if(qaLogData.length === 0) { if(!confirm("QAãƒ­ã‚°ãŒç©ºã§ã™ãŒä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ")) return; }

      const data = {
        companyId: select.value,
        interviewer: document.getElementById('live-interviewer').value,
        qaLog: qaLogData,
        impression: document.getElementById('live-impression').value,
        nextSteps: "è¦ç¢ºèª"
      };

      google.script.run.withSuccessHandler(() => {
        alert("è­°äº‹éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚");
        clearLog();
      }).apiSaveMinutes(data);
    }

    function clearLog() {
      qaLogData = [];
      document.getElementById('qa-container').innerHTML = '<div class="text-muted text-center small mt-5">ã“ã“ã«QAãƒ­ã‚°ãŒè¿½åŠ ã•ã‚Œã¾ã™</div>';
      document.getElementById('live-impression').value = '';
    }

    // --- Tab 3 (Schedule) ---
    function searchSlots() {
      const start = document.getElementById('sched-start').value;
      const end = document.getElementById('sched-end').value;
      const duration = document.getElementById('sched-duration').value;

      if(!start || !end || !duration) {
        alert("æœŸé–“ã¨æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
      }

      document.getElementById('slots-container').innerHTML = '<div class="text-center mt-4"><div class="spinner-border spinner-border-sm text-primary"></div><div class="small text-muted">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç¢ºèªä¸­...</div></div>';
      
      google.script.run
        .withSuccessHandler(showSlots)
        .withFailureHandler(alert)
        .apiGetFreeSlots(start, end, duration);
    }
    
    function showSlots(slots) {
      const container = document.getElementById('slots-container');
      container.innerHTML = '';
      
      if(slots.length == 0) { 
        container.innerHTML = '<div class="text-danger text-center small mt-4">æ¡ä»¶ã«åˆã†ç©ºãæ ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚<br>æ¡ä»¶ã‚’åºƒã’ã¦å†æ¤œç´¢ã—ã¦ãã ã•ã„ã€‚</div>'; 
        return; 
      }
      
      slots.forEach(s => {
        const d = document.createElement('div');
        d.className = 'slot-item border-bottom p-1 small';
        d.textContent = s;
        d.onclick = () => {
          if (d.classList.contains('bg-primary')) {
            d.classList.remove('bg-primary', 'text-white');
          } else {
            d.classList.add('bg-primary', 'text-white');
          }
          updateResult();
        };
        container.appendChild(d);
      });
    }

    function updateResult() {
      const selectedEls = document.querySelectorAll('.slot-item.bg-primary');
      const selectedTexts = Array.from(selectedEls).map(e => e.textContent);
      
      if (selectedTexts.length === 0) {
        document.getElementById('result-area').value = "";
        return;
      }
      document.getElementById('result-area').value = 
        "ä»¥ä¸‹ã®æ—¥ç¨‹ã§èª¿æ•´å¯èƒ½ã§ã™ã€‚\n\n" + selectedTexts.join('\n') + "\n\nã”ç¢ºèªã®ã»ã©ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚";
    }

    function copyToClip() {
      const el = document.getElementById('result-area');
      if(!el.value) return;
      el.select();
      document.execCommand('copy');
    }

    // --- Tab 4 (Offer) ---
    function fillOfferData(data) {
      if(data) {
        document.getElementById('offer-salary').value = data.salary;
        document.getElementById('offer-workstyle').value = data.workStyleText;
        document.getElementById('offer-work-score').value = 3; 
        document.getElementById('offer-tech-score').value = data.techEnvScore;
        document.getElementById('offer-culture-score').value = data.cultureScore;
        document.getElementById('offer-pros').value = data.pros;
        document.getElementById('offer-cons').value = data.cons;
      } else {
        document.getElementById('offer-salary').value = '';
        document.getElementById('offer-workstyle').value = '';
        document.getElementById('offer-pros').value = '';
        document.getElementById('offer-cons').value = '';
      }
    }

    function saveOffer() {
      const select = document.getElementById('company-select');
      if(!select.value) { alert("ä¼æ¥­ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

      const form = {
        companyId: select.value,
        companyName: select.options[select.selectedIndex].text,
        salary: document.getElementById('offer-salary').value || 0,
        workStyleText: document.getElementById('offer-workstyle').value,
        workStyleScore: document.getElementById('offer-work-score').value,
        techEnvScore: document.getElementById('offer-tech-score').value,
        cultureScore: document.getElementById('offer-culture-score').value,
        pros: document.getElementById('offer-pros').value,
        cons: document.getElementById('offer-cons').value
      };

      google.script.run.withSuccessHandler((res) => {
        alert(`ä¿å­˜ã—ã¾ã—ãŸï¼ ç·åˆã‚¹ã‚³ã‚¢: ${res.score}ç‚¹`);
        updateOfferRanking();
      }).apiSaveOffer(form);
    }

    function updateOfferRanking() {
      google.script.run.withSuccessHandler(renderRanking).apiGetOfferComparison();
    }

    function renderRanking(list) {
      const div = document.getElementById('offer-ranking');
      div.innerHTML = '<h6 class="fw-bold border-bottom mb-2">ğŸ† ã‚ªãƒ•ã‚¡ãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h6>';
      if(list.length === 0) {
        div.innerHTML += '<div class="text-muted text-center">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      list.forEach((item, index) => {
        const medal = index === 0 ? 'ğŸ¥‡' : (index === 1 ? 'ğŸ¥ˆ' : 'ğŸ¥‰');
        const salaryStr = parseInt(item.salary).toLocaleString();
        div.innerHTML += `
          <div class="d-flex justify-content-between align-items-center mb-1 p-1 ${index===0 ? 'bg-light' : ''}">
             <div class="text-truncate" style="max-width: 110px;">${medal} <strong>${item.name}</strong></div>
             <div class="text-end">
               <span class="badge bg-light text-dark border me-1">${salaryStr}</span>
               <span class="badge bg-warning text-dark border border-dark">${item.score}pt</span>
             </div>
          </div>`;
      });
    }

    // --- Tab 5 (Register) ---
    function tryFetchTitle() {
      const url = document.getElementById('reg-url').value;
      const nameInput = document.getElementById('reg-name');
      if(url && !nameInput.value) {
        nameInput.placeholder = "å–å¾—ä¸­...";
        google.script.run.withSuccessHandler(title => {
          if(title) nameInput.value = title;
          nameInput.placeholder = "";
        }).apiFetchTitle(url);
      }
    }

    function handleRegister(e) {
      e.preventDefault();
      const btn = document.querySelector('#reg-form button');
      btn.textContent = "ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...";
      btn.disabled = true;

      const form = {
        name: e.target.name.value,
        url: e.target.url.value,
        jobTitle: e.target.jobTitle.value,
        salary: e.target.salary.value,
        jobDescription: e.target.jobDescription.value,
        persona: e.target.persona.value
      };

      google.script.run.withSuccessHandler((res) => {
        alert(`ã€Œ${res.name}ã€ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚\nã€Œæº–å‚™ã€ã‚¿ãƒ–ã§è©³ç´°ã‚’ç¢ºèªã§ãã¾ã™ã€‚`);
        document.getElementById('reg-form').reset();
        btn.textContent = "ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Ÿè¡Œ";
        btn.disabled = false;
        
        // ä¼æ¥­ãƒªã‚¹ãƒˆå†èª­ã¿è¾¼ã¿
        google.script.run.withSuccessHandler(initSidebar).apiGetInitData();
      }).apiRegisterCompany(form);
    }
  </script>
</body>
</html>
